# Worklog

Last updated: 2026-02-10

Use this log for day-to-day progress so history stays easy to query later.

## Entry Template
- Date:
- Task:
- Result:
- Errors:
- Hardships/Operational Issues:
- Fixes:
- Tests:
- Coverage:

## Entries
- Date: 2026-02-10
- Task: Create persistent context archive and project history documents.
- Result: Added/updated `docs/project_state.md` and `docs/project_history.md`.
- Errors: None.
- Hardships/Operational Issues: None.
- Fixes: N/A.
- Tests: N/A (documentation change only).
- Coverage: N/A.

- Date: 2026-02-10
- Task: Persist non-app engineering issues for continuity across sessions.
- Result: Added explicit logging fields and history section for environment/tooling friction.
- Errors: Repeated command interruptions during long-running tasks.
- Hardships/Operational Issues:
  - PATH setup drift (`flutter`/`adb` not recognized).
  - Terminal session restarts causing command context loss.
  - Permission prompt freeze/stuck approval flow in Codex runs.
- Fixes:
  - Standardized PATH/JAVA setup notes in docs.
  - Added this persistent non-app issue log format.
- Tests: N/A (documentation change only).
- Coverage: N/A.

- Date: 2026-02-10
- Task: Add AI-assisted expiry extraction with OCR-text first and image fallback.
- Result:
  - Added AI client with Responses API integration (`gpt-4.1-mini`).
  - Added debug scan status labels (`AI: disabled/no date/failed/text used/image used`).
  - Added image-based AI fallback for difficult packaging when OCR parsing is weak.
- Errors:
  - `AI: disabled` shown initially due missing runtime API key injection.
  - Wireless device connection dropped intermittently during testing.
  - OpenAI usage page did not show immediate request usage (dashboard delay confusion).
- Hardships/Operational Issues:
  - Environment variable setup in Windows terminals was inconsistent between sessions.
  - Needed full rerun with `--dart-define` (hot reload not enough for config changes).
- Fixes:
  - Set `OPENAI_API_KEY` at user environment level and reran app with `--dart-define`.
  - Added explicit runtime scan feedback labels to verify whether AI path was actually used.
  - Added image fallback so hard cases (e.g., water bottle date print) can still be read.
- Tests:
  - Added unit tests for AI client text parsing, image request path, and failure/disabled states.
  - Full suite executed successfully.
- Coverage:
  - 97.27% (249/256) after image-fallback additions.
- User Test Outcomes:
  - Wippy item: AI returned correct date and reported AI usage.
  - Water bottle: OCR remained hard, but AI image fallback succeeded (`AI: image used`).

- Date: 2026-02-10
- Task: Improve duplicate handling for item add/edit while preserving batch-by-expiry use case.
- Result:
  - Implemented exact-duplicate merge (same name + barcode + date + location).
  - Editing one item into another exact duplicate now merges quantity instead of keeping two rows.
  - Different expiration dates remain separate rows to support multiple batches.
- Errors:
  - User-observed confusion where edit could appear to create duplicate rows.
- Hardships/Operational Issues:
  - Behavior ambiguity between true duplicates and intentional same-product multi-batch entries.
- Fixes:
  - Added controller merge logic for add/update operations.
  - Added targeted unit tests for merge and non-merge cases.
- Tests:
  - Full suite passed after implementation.
- Coverage:
  - 97.54% (278/285) at validation time.

- Date: 2026-02-10
- Task: Add free barcode provider fallbacks with configurable order/enabled state and local lookup cache.
- Result:
  - Introduced multi-provider barcode lookup pipeline (all free, no API key required):
    - Open Food Facts
    - Open Beauty Facts
    - Open Products Facts
    - Open Pet Food Facts
  - Added lookup settings persistence (enable/disable + provider order).
  - Added local barcode cache for found and not-found results.
  - Added settings UI to reorder/toggle providers and clear barcode cache.
  - Wired `AddItemScreen` barcode name lookup to new service.
- Errors:
  - Prior run was interrupted mid-implementation; resumed and verified state before continuing.
- Hardships/Operational Issues:
  - Coverage dipped after adding new modules; added targeted tests to restore quality baseline.
- Fixes:
  - Added dedicated tests for cache, provider client, models, and service fallback/caching behavior.
- Tests:
  - Full suite passed.
- Coverage:
  - 95.08% (425/447).

- Date: 2026-02-10
- Task: Fix barcode scanner URL capture and stale not-found cache behavior.
- Result:
  - Scanner now accepts only numeric product barcode candidates (EAN/UPC/GTIN-like).
  - Barcode lookup service no longer treats cached `notFound` as authoritative.
  - Service now caches only successful `found` lookups for stability.
- Errors:
  - Scanner sometimes returned website links from QR codes instead of product barcode.
  - Previously found products could fail later due stale cached not-found entries.
- Hardships/Operational Issues:
  - Regression surfaced only after integrating provider fallback + cache.
- Fixes:
  - Tightened barcode parser validation.
  - Updated lookup cache policy and service logic.
  - Added regression tests for both issues.
- Tests:
  - Full suite passed.
- Coverage:
  - 94.67% (426/450).

- Date: 2026-02-10
- Task: Add local expiration notification feature and settings structure refactor.
- Result:
  - Added local notification scheduler and wired reminder sync into inventory lifecycle (load/add/edit/delete/restore).
  - Added Android notification permission and required desugaring config for `flutter_local_notifications`.
  - Added notification test helper in Debug Tools and changed it to immediate send for deterministic QA.
  - Refactored Settings into a hub screen with thematic separation:
    - Barcode Providers
    - Debug Tools
  - Improved provider list UX:
    - compact rows
    - aligned explicit drag handles
    - clearer reorder affordance.
- Errors:
  - Android build failed with `checkDebugAarMetadata` desugaring requirement.
  - Web list update appeared stale due notification scheduler behavior on unsupported platform.
  - Delayed test notification did not consistently appear when scheduled for ~1 minute.
- Hardships/Operational Issues:
  - Platform-specific notification behavior required web-safe guards and deterministic debug flow.
- Fixes:
  - Enabled core library desugaring and added `desugar_jdk_libs`.
  - Disabled scheduler creation on web and made scheduler failures non-blocking for UI updates.
  - Switched debug notification to immediate send and added permission-aware error feedback.
- Tests:
  - Added scheduler helper tests and extended controller tests for reminder sync.
  - Full and targeted test passes completed during implementation.
- Coverage:
- 88.29% (445/504) at latest full run in this iteration.

- Date: 2026-02-10
- Task: Complete daily summary notification UX (tap navigation, snooze actions, confirmation, settings control).
- Result:
  - Added daily summary notification behavior with compact body text.
  - Tap on summary notification now opens inventory and applies Today filter.
  - Added snooze actions (12:00 / 17:00) and confirmation notification.
  - Added `Settings -> Notifications` screen with manual snooze controls.
  - Added/updated scheduler helper tests and kept full suite passing.
- Errors:
  - Notification action taps initially did not show confirmation.
  - Day context in snooze feedback was ambiguous (hour only).
- Hardships/Operational Issues:
  - Android action callback behavior required UI-mode handling for consistent feedback.
- Fixes:
  - Enabled UI handling on snooze actions.
  - Added relative day labels (`today` / `tomorrow` / explicit date) to confirmation text.
- Tests:
  - Targeted scheduler tests passed.
  - Full suite passed (81 tests).
- Coverage:
  - Not re-measured with `--coverage` in this sub-step; previous measured snapshot remains 88.29% (445/504).

- Date: 2026-02-10
- Task: Add notification QA debug panel details and stabilization fixes.
- Result:
  - Added scheduled-notification debug list (id/type/title/time) with refresh.
  - Added debug action to clear scheduled notifications for clean QA repro.
  - Added fallback classification/time inference for legacy pending reminders without payload metadata.
  - Fixed summary-snooze overwrite issue by preserving one existing pending summary during reminder sync.
- Errors:
  - Some scheduled entries showed `unknown` type and `time unknown`.
  - Snoozed summary for tomorrow could be replaced during app sync/reopen.
- Hardships/Operational Issues:
  - Legacy pending notifications from earlier builds lacked payload metadata.
- Fixes:
  - Added payload fallback inference and managed-reminder cancellation logic.
  - Kept exactly one pending summary during sync to avoid clobbering snoozed summary.
- Tests:
  - Targeted scheduler tests passed.
  - Full suite passed (83 tests).
- Coverage:
  - Not re-measured with `--coverage` in this sub-step.
